# ceph-exporter-k8s

Based on digitalocen ceph_exporter for Docker ![Build Status](https://travis-ci.org/digitalocean/ceph_exporter.svg)

This is a translation from ceph_exporter docker image to kubernetes, the trick is in reusing the config maps and secrets, generated by ceph helm on the ceph namespace.
I decided to create a separate deployment inside ceph namespaces and not doing a sidecar to the MONS, I know ceph won't like that way ;)

Ceph was deployed to Kubernetes following official [ceph helm docs](https://github.com/ceph/ceph-helm)

Prometheus exporter that scrapes meta information about a running ceph cluster. All the information gathered from the cluster is done by interacting with the monitors using an appropriate wrapper over `rados_mon_command()` , for more information see
[official Golang client](https://github.com/ceph/go-ceph) 

## Requeriments
A kubernetes cluster 1.7+
Ceph helm deployed on the kubernetes cluster

## Deployment
```
git clone this repo
kubectl create -f ceph-exporter-k8s/
```

## Metrics e.g
```
kubectl exec -ti ceph-node-exporter -n ceph -- curl localhost:9128/metrics
# TYPE ceph_osd_avail_bytes gauge
ceph_osd_avail_bytes{cluster="ceph",osd="osd.0"} 2.0831872e+10
ceph_osd_avail_bytes{cluster="ceph",osd="osd.1"} 2.0837068e+10
ceph_osd_avail_bytes{cluster="ceph",osd="osd.2"} 2.0832808e+10
ceph_osd_avail_bytes{cluster="ceph",osd="osd.3"} 2.083154e+10
ceph_osd_avail_bytes{cluster="ceph",osd="osd.4"} 2.0834028e+10
ceph_osd_avail_bytes{cluster="ceph",osd="osd.5"} 2.0825772e+10
# HELP ceph_osd_average_utilization OSD Average Utilization
# TYPE ceph_osd_average_utilization gauge
ceph_osd_average_utilization{cluster="ceph"} 0.610941
...
...
```

## Prometheus and RBAC
This part needs to improve, right now configuration is set to use prometheus-k8s service account
- ServiceMonitor runs on `monitoring` namespace
- Prometheus CRD also resides on `monitoring` namespace

## Other ways to do it
From official ceph docs
http://docs.ceph.com/docs/master/mgr/prometheus/

## Sample view

